# 単体テストチェックリスト

## MyVTNService ハンドラー関数

### 異常系 XML以外のデータが送られてくる
- [ ] リクエストヘッダー`content-type`が`application/xml`で始まらない
    - [ ] エラー`400 BadRequest`が返されること
    - [ ] 受信したメッセージの処理が実行されないこと

### 異常系 XMLスキーマ検証失敗
- [ ] 受け取ったXMLを確認する処理でエラー（`XMLSyntaxError`）が発生する
    - [ ] エラー`400 BadRequest`が返されること
    - [ ] 受信したメッセージの処理が実行されないこと

### 異常系 VENの登録情報が取得できない
- [ ] メッセージの種類がパーティ登録以外（`oadrCreatePartyRegistration`、`oadrQueryRegistration`以外）
- [ ] `ven_lookup`の結果が空 または `registration_id`が入っていない
    - [ ] ステータスコード`200`が返されること
    - [ ] 受信したメッセージの処理が実行されないこと

### 異常系 フィンガープリントが一致しない
- [ ] 証明書の照合処理（`authenticate_message`）で`FingerprintMismatch`エラーが発生する
    - [ ] エラー`403 Forbidden`が返されること
    - [ ] 受信したメッセージの処理が実行されないこと

### 異常系 VTN IDが異なる
- [ ] 受信したメッセージの`vtn_id`がVTNサーバーの設定値と異なる
    - [ ] ステータスコード`200`が返されること
    - [ ] 受信したメッセージの処理が実行されないこと

### oadrResponseを受信
- [ ] メッセージの種類が`oadrResponse`
    - [ ] ステータスコード`200`が返されること

### 正常系 パーティ登録（oadrQueryRegistration）を受信
- [ ] メッセージの種類が`oadrQueryRegistration`
- [ ] `X-Amzn-Mtls-Clientcert-Leaf`ヘッダーから証明書の指紋（fingerprint）を取得できる
- [ ] 指紋をメッセージの情報に付け足して`handle_message`へ渡す
    - [ ] ステータスコード`200`が返されること

### 正常系 パーティ登録（oadrCreatePartyRegistration）を受信
- [ ] メッセージの種類が`oadrCreatePartyRegistration`
- [ ] `X-Amzn-Mtls-Clientcert-Leaf`ヘッダーから証明書の指紋（fingerprint）を取得できる
- [ ] 指紋をメッセージの情報に付け足して`handle_message`へ渡す
    - [ ] ステータスコード`200`が返されること

### 正常系 登録済みVENからパーティ登録以外を受信
- [ ] メッセージの種類が`oadrQueryRegistration`または`oadrCreatePartyRegistration`以外
- [ ] `ven_lookup`が登録済み情報（`registration_id`を含む）を返す
    - [ ] ステータスコード`200`が返されること
