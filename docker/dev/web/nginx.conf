worker_processes  1;

events {
    worker_connections 1024;
}

http {
    access_log /dev/stdout;
    error_log /dev/stderr notice;

    upstream vtn_upstream {
        server openadr-vtn:8080;
    }

    # デバッグログで mTLS の成立も見る
    log_format dbg '$remote_addr $request $status '
                    '$ssl_client_verify:$ssl_client_serial '
                    '$ssl_protocol/$ssl_cipher';
    access_log /dev/stdout dbg;
    error_log /dev/stderr debug;

    server {
        listen 443 ssl;
        server_name openadr-web;

        ssl_certificate        /etc/nginx/certs/dummy_vtn.crt;
        ssl_certificate_key    /etc/nginx/certs/dummy_vtn.key;
        ssl_client_certificate /etc/nginx/certs/dummy_ca.crt;   
        ssl_verify_client         on;               # VEN クライアント証明書必須
        ssl_protocols             TLSv1.2 TLSv1.3;

        add_header X-Debug-Arrived-Server docker-nginx always;
        add_header X-Debug-Client-Verify $ssl_client_verify always;

        location / {
            proxy_pass http://vtn_upstream;

            # お作法（1.1/コネクション再利用）
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;                    # ← 今 "openadr-web:443" と見えてるのは $proxy_host を使っている可能性大
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;

            # ここからデバッグ固定ヘッダー
            proxy_set_header X-Debug-Ping ping;            # ← これが見えなければ、そのlocationに来ていない
            proxy_set_header X-Debug-Where $request_uri;   # ← どのパスかも確認

            # 既存のX-Forwardedはそのまま
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host              $host;

            # mTLS系（値が空でも“ヘッダー自体”は来る）
            proxy_set_header X-Amzn-Mtls-Clientcert-Serial-Number $ssl_client_serial;
            proxy_set_header X-Amzn-Mtls-Clientcert-Issuer        $ssl_client_i_dn;
            proxy_set_header X-Amzn-Mtls-Clientcert-Subject       $ssl_client_s_dn;
            proxy_set_header X-Amzn-Mtls-Clientcert-NotBefore     $ssl_client_v_start;
            proxy_set_header X-Amzn-Mtls-Clientcert-NotAfter      $ssl_client_v_end;
            proxy_set_header X-Amzn-Mtls-Clientcert-Leaf          $ssl_client_escaped_cert;

            
            # 念のため（無効化されていないことを明示）
            proxy_pass_request_headers on;
        }
    }
}
