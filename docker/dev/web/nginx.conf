worker_processes 1;

events {
    worker_connections 1024;
}

http {
  lua_package_path "/usr/local/openresty/site/lualib/?.lua;;";

  upstream vtn {
    server openadr-vtn:80;
    keepalive 16;
  }

  server {
    listen 443 ssl;
    server_name openadr-web;

    # サーバ証明書
    ssl_certificate     /etc/nginx/certs/dummy_vtn.crt;
    ssl_certificate_key /etc/nginx/certs/dummy_vtn.key;

    # クライアント証明書を受け取る
    ssl_client_certificate /etc/nginx/certs/dummy_ca.crt;
    ssl_verify_client on;

    # リクエスト毎にALB互換のヘッダを付与
    access_by_lua_block {
      local x509 = require "resty.openssl.x509"

      local raw_pem = ngx.var.ssl_client_raw_cert
      if not raw_pem or raw_pem == "" then
        -- クライアント証明書が無い場合は何もしない（ALBに合わせて未付与）
      else
        local cert, err = x509.new(raw_pem)
        if not cert then
          ngx.log(ngx.ERR, "failed to parse client cert: ", err)
        else
          -- Serial (HEX, 大文字)
          local bn, e1 = cert:get_serial_number()
          local serial_hex = bn and bn:to_hex() or nil
          if serial_hex then serial_hex = string.upper(serial_hex) end

          -- Issuer / Subject (RFC2253)
          local issuer = cert:get_issuer_name()
          local subject = cert:get_subject_name()
          local issuer_rfc2253 = issuer and issuer:tostring({ flags = "RFC2253" }) or nil
          local subject_rfc2253 = subject and subject:tostring({ flags = "RFC2253" }) or nil

          -- Validity (ISO8601 Z) → "NotBefore=...; NotAfter=..."
          local nb = cert:get_not_before()
          local na = cert:get_not_after()
          local function iso8601_z(t)
            return t and os.date("!%Y-%m-%dT%H:%M:%SZ", t) or nil
          end
          local validity = (nb and na) and
            ("NotBefore=%s; NotAfter=%s"):format(iso8601_z(nb), iso8601_z(na)) or nil

          -- Leaf（PEMのURLエンコード）
          local leaf_urlenc = ngx.escape_uri(raw_pem)

          if serial_hex then
            ngx.req.set_header("X-Amzn-Mtls-Clientcert-Serial-Number", serial_hex)
          end
          if issuer_rfc2253 then
            ngx.req.set_header("X-Amzn-Mtls-Clientcert-Issuer", issuer_rfc2253)
          end
          if subject_rfc2253 then
            ngx.req.set_header("X-Amzn-Mtls-Clientcert-Subject", subject_rfc2253)
          end
          if validity then
            ngx.req.set_header("X-Amzn-Mtls-Clientcert-Validity", validity)
          end
          if leaf_urlenc then
            ngx.req.set_header("X-Amzn-Mtls-Clientcert-Leaf", leaf_urlenc)
          end
        end
      end
    }

    location / {
      proxy_pass http://openadr-vtn:8080;
    }
  }
}
